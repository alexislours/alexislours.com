---
import { getCollection } from "astro:content";
import Layout from "@layouts/Layout.astro";
import Header from "@components/Header.astro";
import Footer from "@components/Footer.astro";
import InteractiveMap from "@components/InteractiveMap.svelte";

const mapboxToken = import.meta.env.MAPBOX_PUBLIC_ACCESS_TOKEN;

const allPhotos = await getCollection("photos");

const photosWithLocation = allPhotos
  .filter((photo) => {
    const { latitude, longitude } = photo.data;
    return latitude && longitude;
  })
  .map((photo) => ({
    id: photo.id,
    title: photo.data.title,
    description: photo.data.description || "",
    date_taken: photo.data.date_taken,
    url_o: photo.data.imageUrls.original.url,
    url_500:
      photo.data.imageUrls["500px"]?.url || photo.data.imageUrls.original.url,
    width_o: photo.data.imageUrls.original.width,
    height_o: photo.data.imageUrls.original.height,
    latitude: photo.data.latitude,
    longitude: photo.data.longitude,
    locationName: photo.data.locationName,
  }))
  .sort(
    (a, b) =>
      new Date(b.date_taken).getTime() - new Date(a.date_taken).getTime()
  );

const title = "Photo Map - Alexis LOURS";
const description =
  "Interactive map showing the locations where photos were taken.";
const ogImage = photosWithLocation[0]?.url_o;
---

<Layout
  title={title}
  description={description}
  ogImage={ogImage}>
  <main>
    <Header title="Photo Map" />

    <div class="mx-auto max-w-7xl px-4 py-6">
      <div class="mb-6">
        <p class="text-gray-600">
          Explore {photosWithLocation.length} photos on the interactive map below.
          Click on any marker to see the photo details.
        </p>
      </div>

      <div
        class="h-[70vh] min-h-[500px] w-full overflow-hidden rounded-lg shadow-lg">
        <InteractiveMap
          photos={photosWithLocation}
          mapboxToken={mapboxToken}
          client:load
        />
      </div>
    </div>
  </main>

  <Footer />
</Layout>

<style>
  :global(.mapboxgl-popup-content) {
    padding: 0;
    border-radius: 8px;
  }

  :global(.mapboxgl-popup-tip) {
    border-top-color: #ffffff;
  }
</style>

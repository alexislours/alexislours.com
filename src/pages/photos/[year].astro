---
import { getCollection } from "astro:content";
import type { CollectionEntry } from "astro:content";
import { getImage } from "astro:assets";
import PhotoYearLayout from "@layouts/PhotoYearLayout.astro";

export async function getStaticPaths() {
  const getPhotoYear = (photo: CollectionEntry<"photoShowcase">): number => {
    return new Date(photo.data.date_taken).getFullYear();
  };

  const allPhotos = await getCollection("photoShowcase");

  const yearsSet = new Set<number>();
  allPhotos.forEach((photo) => {
    const year = getPhotoYear(photo);
    yearsSet.add(year);
  });

  const availableYears = Array.from(yearsSet).sort((a, b) => b - a);

  return availableYears.map((year) => ({
    params: { year: year.toString() },
  }));
}

const getPhotoYear = (photo: CollectionEntry<"photoShowcase">): number => {
  return new Date(photo.data.date_taken).getFullYear();
};

const { year } = Astro.params;
const yearNum: number = parseInt(year);

const allPhotos: CollectionEntry<"photoShowcase">[] =
  await getCollection("photoShowcase");

const filteredPhotos = allPhotos.filter((photo) => {
  const photoYear = getPhotoYear(photo);
  return photoYear === yearNum;
});

const sortedPhotos: CollectionEntry<"photoShowcase">[] = filteredPhotos.sort(
  (a, b) =>
    new Date(b.data.date_taken).getTime() -
    new Date(a.data.date_taken).getTime()
);

if (sortedPhotos.length === 0) {
  return Astro.redirect("/photos");
}

const photoCount: number = sortedPhotos.length;
const title = `${year} - Alexis LOURS`;
const description = `My best pictures taken in ${year}.`;
const ogImage = sortedPhotos[0]?.data.imageUrls.original.url;

const optimizedBackgrounds = await Promise.all(
  sortedPhotos.map(async (photo) => {
    const thumbUrl =
      photo.data.imageUrls["240px"]?.url ||
      photo.data.imageUrls["320px"]?.url ||
      photo.data.imageUrls.original.url;
    const thumbWidth =
      photo.data.imageUrls["240px"]?.width ||
      photo.data.imageUrls["320px"]?.width ||
      photo.data.imageUrls.original.width;
    const thumbHeight =
      photo.data.imageUrls["240px"]?.height ||
      photo.data.imageUrls["320px"]?.height ||
      photo.data.imageUrls.original.height;

    const optimizedImage = await getImage({
      src: thumbUrl,
      width: 400,
      height: Math.round(400 * (thumbHeight / thumbWidth)),
      format: "avif",
    });

    return optimizedImage.src;
  })
);

const yearsSet = new Set<number>();
allPhotos.forEach((photo) => {
  const photoYear = getPhotoYear(photo);
  yearsSet.add(photoYear);
});

const otherYears: number[] = Array.from(yearsSet)
  .filter((y) => y !== yearNum)
  .sort((a, b) => b - a);

type YearWithPhoto = {
  year: number;
  photo: CollectionEntry<"photoShowcase">;
};

const otherYearsWithPhotos: YearWithPhoto[] = await Promise.all(
  otherYears.map(async (otherYear) => {
    const yearPhotos = allPhotos.filter((photo) => {
      const photoYear = getPhotoYear(photo);
      return photoYear === otherYear;
    });

    const sortedYearPhotos = yearPhotos.sort(
      (a, b) =>
        new Date(b.data.date_taken).getTime() -
        new Date(a.data.date_taken).getTime()
    );

    return {
      year: otherYear,
      photo: sortedYearPhotos[0],
    };
  })
);
---

<PhotoYearLayout
  year={year}
  photoCount={photoCount}
  sortedPhotos={sortedPhotos}
  optimizedBackgrounds={optimizedBackgrounds}
  otherYearsWithPhotos={otherYearsWithPhotos}
  title={title}
  description={description}
  ogImage={ogImage}
/>

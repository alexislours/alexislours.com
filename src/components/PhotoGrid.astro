---
import { Picture } from "astro:assets";

interface Photo {
  id: string;
  url_o: string;
  title: string;
  date_taken: Date;
  description: string;
  width_o: number;
  height_o: number;
}

interface Props {
  photos: Photo[];
  basePath?: string;
}

const { photos, basePath = "/photo" } = Astro.props;
---

<section class="section">
  {
    photos.map((photo, index) => {
      const aspectRatio = photo.width_o / photo.height_o;
      const width = aspectRatio * 250;
      const paddingBottom = (1 / aspectRatio) * 100;

      return (
        <a
          href={`${basePath}/${photo.id}/`}
          class="group link"
          data-umami-event="Click photo in grid"
          data-umami-event-id={photo.id}
          style={`width: ${width}px; flex-grow: ${width}`}>
          <div
            class="block"
            style={`padding-bottom: ${paddingBottom}%`}
          />
          <Picture
            src={photo.url_o}
            fetchpriority={index < 5 ? "high" : "auto"}
            alt={photo.description || photo.title || "Photo"}
            class="photo-fade photo"
            formats={["avif"]}
            loading={index < 5 ? "eager" : "lazy"}
            fallbackFormat="jpg"
            width={photo.width_o}
            height={photo.height_o}
            sizes={`(max-width: 768px) 100vw, (max-width: 1024px) 50vw, min(33vw, 400px)`}
            widths={[320, 640, 400, 800, 1024, 1280]}
          />
        </a>
      );
    })
  }
</section>

<style>
  .section {
    display: flex;
    flex-wrap: wrap;
    margin: 3px;
  }
  .section:after {
    content: "";
    flex-grow: 10;
  }
  .link {
    position: relative;
    margin: 5px;
    cursor: pointer;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    overflow: hidden;
    border-radius: 2px;
    box-shadow:
      0 1px 3px rgba(0, 0, 0, 0.04),
      0 1px 2px rgba(0, 0, 0, 0.02);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .link::before {
    content: "";
    position: absolute;
    inset: 0;
    border: 1px solid rgba(255, 255, 255, 0.4);
    border-radius: 2px;
    pointer-events: none;
    z-index: 2;
    opacity: 0;
    transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .link::after {
    content: "";
    position: absolute;
    inset: 0;
    background: repeating-linear-gradient(
      0deg,
      rgba(0, 0, 0, 0.015) 0px,
      transparent 1px,
      transparent 2px,
      rgba(0, 0, 0, 0.015) 3px
    );
    pointer-events: none;
    z-index: 1;
    opacity: 0.3;
    mix-blend-mode: overlay;
  }

  .link:hover {
    box-shadow:
      0 12px 28px rgba(0, 0, 0, 0.08),
      0 6px 12px rgba(0, 0, 0, 0.06),
      0 2px 6px rgba(0, 0, 0, 0.04);
  }

  .link:hover::before {
    opacity: 1;
  }

  .photo {
    position: absolute;
    top: 0;
    height: 100%;
    width: 100%;
    object-fit: cover;
    transition:
      transform 0.3s ease-out,
      opacity 0.3s ease-out,
      filter 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    filter: brightness(1) contrast(1.02) saturate(1.05);
  }

  .link:hover .photo {
    transform: scale(1.05);
    opacity: 0.95;
    filter: brightness(1.05) contrast(1.03) saturate(1.08);
  }

  .photo-fade {
    opacity: 0;
  }

  .photo-fade.loaded {
    opacity: 1;
  }

  @media (prefers-reduced-motion: reduce) {
    .link,
    .link::before,
    .photo {
      transition: none;
    }

    .link:hover .photo {
      transform: scale(1.02);
    }
  }
</style>

<style is:global>
  .no-js .photo-fade {
    opacity: 1 !important;
  }
</style>

<script is:inline>
  document.documentElement.classList.remove("no-js");

  function initializePhotos() {
    const photos = document.querySelectorAll(
      ".photo-fade:not([data-processed])"
    );

    photos.forEach((photo) => {
      if (photo.complete && photo.naturalHeight !== 0) {
        photo.classList.add("loaded");
      } else {
        photo.addEventListener("load", () => photo.classList.add("loaded"));
        photo.addEventListener("error", () => photo.classList.add("loaded"));
      }

      photo.dataset.processed = "true";
    });
  }

  initializePhotos();
  document.addEventListener("astro:after-swap", initializePhotos);
</script>

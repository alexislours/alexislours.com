---
import { Picture } from "astro:assets";
import MapBox from "@components/MapBox.astro";

interface Props {
  currentPhoto: {
    id: string;
    url_o: string;
    title: string;
    date_taken: Date;
    description: string;
    width_o: number;
    height_o: number;
    latitude: number;
    longitude: number;
    locationName?: string;
    tags?: string[];
    exif?: Record<
      string,
      {
        value: string;
        clean?: string;
        raw?: string;
      }
    >;
  };
  photoIndex: number;
  totalPhotos: number;
  prevId: string | null;
  nextId: string | null;
  basePath: string;
  backUrl: string;
  backLabel: string;
  showLicense?: boolean;
}

const {
  currentPhoto,
  photoIndex,
  totalPhotos,
  prevId,
  nextId,
  basePath,
  backUrl,
  backLabel,
  showLicense = false,
} = Astro.props;

const formatDate = (date: Date) => {
  return new Intl.DateTimeFormat("en-US", {
    year: "numeric",
    month: "long",
    day: "numeric",
    hour: "2-digit",
    minute: "2-digit",
  }).format(new Date(date));
};
---

<div class="fixed inset-0 overflow-hidden bg-black text-white">
  <header
    class="absolute top-0 right-0 left-0 z-20 bg-linear-to-b from-black/80 to-transparent">
    <div class="flex items-center justify-between p-4">
      <a
        href={backUrl}
        class="flex items-center gap-2 text-white/90 transition-colors hover:text-white"
        data-umami-event={`Back to ${backLabel}`}
        aria-label={`Back to ${backLabel}`}>
        <svg
          class="h-6 w-6"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M10 19l-7-7m0 0l7-7m-7 7h18"
          ></path>
        </svg>
        <span class="hidden sm:inline"> Back </span>
      </a>
      <div class="flex items-center gap-4">
        <div class="text-sm text-white/80">
          {photoIndex + 1} of {totalPhotos}
        </div>
        <button
          id="sidebar-toggle"
          data-umami-event="Toggle photo sidebar"
          class="cursor-pointer rounded-lg bg-black/20 p-2 transition-colors hover:bg-black/40"
          title="Toggle info (I)">
          <svg
            class="h-5 w-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
            ></path>
          </svg>
        </button>
      </div>
    </div>
  </header>

  <div class="flex h-full flex-col lg:flex-row">
    <div
      class="relative flex min-h-0 min-w-0 flex-1 items-center justify-center">
      <Picture
        src={currentPhoto.url_o}
        alt={currentPhoto.description || currentPhoto.title || "Photo"}
        class="h-auto max-h-screen w-auto max-w-full object-contain"
        formats={["avif"]}
        fetchpriority="high"
        loading="eager"
        fallbackFormat="jpg"
        width={currentPhoto.width_o}
        height={currentPhoto.height_o}
        layout="constrained"
      />

      {
        prevId && (
          <a
            href={`${basePath}/${prevId}/`}
            data-umami-event="Previous photo"
            id="nav-left"
            class="group absolute top-0 left-0 z-10 h-full w-1/3 cursor-pointer"
            title="Previous photo"
            aria-label="Previous photo">
            <div class="flex h-full items-center justify-start pl-6 opacity-0 transition-opacity duration-300 group-hover:opacity-100">
              <div class="transform rounded-full bg-black/60 p-3 text-white shadow-lg backdrop-blur-sm transition-transform duration-200 group-hover:scale-110">
                <svg
                  class="h-6 w-6"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M15 19l-7-7 7-7"
                  />
                </svg>
              </div>
            </div>
          </a>
        )
      }

      {
        nextId && (
          <a
            href={`${basePath}/${nextId}/`}
            data-umami-event="Next photo"
            id="nav-right"
            class="group absolute top-0 right-0 z-10 h-full w-1/3 cursor-pointer"
            title="Next photo"
            aria-label="Next photo">
            <div class="flex h-full items-center justify-end pr-6 opacity-0 transition-opacity duration-300 group-hover:opacity-100">
              <div class="transform rounded-full bg-black/60 p-3 text-white shadow-lg backdrop-blur-sm transition-transform duration-200 group-hover:scale-110">
                <svg
                  class="h-6 w-6"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 5l7 7-7 7"
                  />
                </svg>
              </div>
            </div>
          </a>
        )
      }
    </div>

    <aside
      id="sidebar"
      class="sidebar-default max-h-[60vh] w-full overflow-y-auto border-t border-gray-200 bg-white text-gray-900 lg:max-h-none lg:w-80 lg:border-t-0 lg:border-l lg:pt-14">
      <div class="space-y-8 p-6">
        {
          currentPhoto.title && (
            <div>
              <h1 class="font-serif text-3xl font-light leading-tight tracking-tight text-gray-900">
                {currentPhoto.title}
              </h1>
            </div>
          )
        }

        {
          currentPhoto.description && (
              <p
                class="font-sans text-sm leading-relaxed text-gray-700">
                {currentPhoto.description}
              </p>
          )
        }

        {
          showLicense && (
            <div class="space-y-4 border-b border-gray-100 pb-6">
              <a
                href={currentPhoto.url_o}
                target="_blank"
                data-umami-event="Download photo"
                rel="noopener noreferrer"
                class="group flex w-full items-center justify-center gap-2.5 rounded border border-gray-300 bg-white px-4 py-2.5 font-sans text-sm font-medium text-gray-900 transition-all hover:border-gray-900 hover:bg-gray-50">
                <svg
                  class="h-4 w-4 transition-transform group-hover:translate-y-0.5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3"
                  />
                </svg>
                Download Original
              </a>
              <p class="text-center font-sans text-xs leading-relaxed text-gray-500">
                Licensed under{" "}
                <a
                  href="https://creativecommons.org/licenses/by/4.0/"
                  target="_blank"
                  rel="noopener noreferrer"
                  data-umami-event="License"
                  class="text-gray-700 underline decoration-gray-300 transition-colors hover:text-gray-900 hover:decoration-gray-500">
                  CC BY 4.0
                </a>
              </p>
            </div>
          )
        }

        <div class="space-y-1">
          <h2 class="font-sans text-xs font-medium uppercase tracking-wider text-gray-500">Date Taken</h2>
          <p
            class="font-sans text-sm text-gray-900">
            {formatDate(currentPhoto.date_taken)}
          </p>
        </div>

        <div class="space-y-2 border-t border-gray-100 pt-6">
          <h2 class="font-sans text-xs font-medium uppercase tracking-wider text-gray-500">Image Details</h2>
          <div class="font-sans text-sm text-gray-700">
            <div class="flex justify-between py-1">
              <span class="text-gray-500">Dimensions</span>
              <span class="font-medium text-gray-900">{currentPhoto.width_o} Ã— {currentPhoto.height_o}</span>
            </div>
          </div>
        </div>

        {
          currentPhoto.exif?.Model || currentPhoto.exif?.Lens ? (
            <div class="space-y-2 border-t border-gray-100 pt-6">
              <h2 class="font-sans text-xs font-medium uppercase tracking-wider text-gray-500">
                Camera
              </h2>
              <div class="space-y-1.5 font-sans text-sm text-gray-700">
                {currentPhoto.exif.Model && (
                  <div class="wrap-break-word font-medium text-gray-900">
                    {currentPhoto.exif.Model.clean ||
                      currentPhoto.exif.Model.value}
                  </div>
                )}
                {currentPhoto.exif.Lens && (
                  <div class="wrap-break-word text-gray-700">
                    {currentPhoto.exif.Lens.clean ||
                      currentPhoto.exif.Lens.value}
                  </div>
                )}
              </div>
            </div>
          ) : null
        }

        {
          currentPhoto.exif?.ExposureTime ||
          currentPhoto.exif?.FNumber ||
          currentPhoto.exif?.FocalLength ||
          currentPhoto.exif?.ISO ? (
            <div class="space-y-2 border-t border-gray-100 pt-6">
              <h2 class="font-sans text-xs font-medium uppercase tracking-wider text-gray-500">
                Settings
              </h2>
              <div class="grid grid-cols-2 gap-3 font-sans text-sm">
                {currentPhoto.exif.FNumber &&
                  currentPhoto.exif.FNumber.clean !== "f/undef" && (
                    <div class="space-y-0.5">
                      <div class="text-xs text-gray-500">Aperture</div>
                      <div class="font-medium text-gray-900">
                        {currentPhoto.exif.FNumber.clean ||
                          currentPhoto.exif.FNumber.value}
                      </div>
                    </div>
                  )}
                {currentPhoto.exif.ExposureTime && (
                  <div class="space-y-0.5">
                    <div class="text-xs text-gray-500">Shutter</div>
                    <div class="font-medium text-gray-900">{currentPhoto.exif.ExposureTime.raw}</div>
                  </div>
                )}
                {currentPhoto.exif.ISO && (
                  <div class="space-y-0.5">
                    <div class="text-xs text-gray-500">ISO</div>
                    <div class="font-medium text-gray-900">
                      {currentPhoto.exif.ISO.clean ||
                        currentPhoto.exif.ISO.value}
                    </div>
                  </div>
                )}
                {currentPhoto.exif.FocalLength && (
                  <div class="space-y-0.5">
                    <div class="text-xs text-gray-500">Focal Length</div>
                    <div class="font-medium text-gray-900">
                      {currentPhoto.exif.FocalLength.clean ||
                        currentPhoto.exif.FocalLength.value}
                    </div>
                  </div>
                )}
              </div>
            </div>
          ) : null
        }

        {currentPhoto.locationName && (
          <div class="space-y-3 border-t border-gray-100 pt-6">
            <div class="space-y-1">
              <h2 class="font-sans text-xs font-medium uppercase tracking-wider text-gray-500">Location</h2>
              <p class="font-sans text-sm text-gray-900">
                {currentPhoto.locationName}
              </p>
            </div>
            <MapBox
              latitude={currentPhoto.latitude}
              longitude={currentPhoto.longitude}
              locationName={currentPhoto.locationName}
              width={300}
              height={300}
              zoom={13}
            />
          </div>
        )}
      </div>
    </aside>
  </div>
</div>

<style>
  aside::-webkit-scrollbar {
    width: 4px;
  }

  aside::-webkit-scrollbar-track {
    background: transparent;
  }

  aside::-webkit-scrollbar-thumb {
    background: rgba(0, 0, 0, 0.2);
    border-radius: 2px;
  }

  aside::-webkit-scrollbar-thumb:hover {
    background: rgba(0, 0, 0, 0.3);
  }

  .sidebar-default {
    display: none;
  }

  @media (min-width: 1024px) {
    .sidebar-default {
      display: block;
    }
  }

  .sidebar-hidden {
    display: none !important;
  }

  .sidebar-show {
    display: block !important;
    z-index: 30;
  }
</style>

<script is:inline define:vars={{ prevId, nextId, basePath, backUrl }}>
  document.addEventListener("keydown", (e) => {
    if (e.key === "ArrowLeft" && prevId) {
      umami.track("Previous photo");
      window.location.href = `${basePath}/${prevId}/`;
    } else if (e.key === "ArrowRight" && nextId) {
      umami.track("Next photo");
      window.location.href = `${basePath}/${nextId}/`;
    } else if (e.key === "Escape") {
      umami.track(`Back to ${backUrl}`);
      window.location.href = backUrl;
    } else if (e.key === "i" || e.key === "I") {
      umami.track("Toggle photo sidebar");
      toggleSidebar();
    }
  });

  function toggleSidebar() {
    const sidebar = document.getElementById("sidebar");
    if (sidebar) {
      if (window.innerWidth >= 1024) {
        sidebar.classList.toggle("sidebar-hidden");
        sessionStorage.setItem(
          "sidebar-hidden-desktop",
          sidebar.classList.contains("sidebar-hidden").toString()
        );
      } else {
        sidebar.classList.toggle("sidebar-show");
        sessionStorage.setItem(
          "sidebar-show-mobile",
          sidebar.classList.contains("sidebar-show").toString()
        );
      }
    }
  }

  function restoreSidebarState() {
    const sidebar = document.getElementById("sidebar");
    if (sidebar) {
      if (window.innerWidth >= 1024) {
        const isHidden =
          sessionStorage.getItem("sidebar-hidden-desktop") === "true";
        if (isHidden) {
          sidebar.classList.add("sidebar-hidden");
        } else {
          sidebar.classList.remove("sidebar-hidden");
        }
      } else {
        const isShown =
          sessionStorage.getItem("sidebar-show-mobile") === "true";
        if (isShown) {
          sidebar.classList.add("sidebar-show");
        } else {
          sidebar.classList.remove("sidebar-show");
        }
      }
    }
  }

  let toggleButton = null;

  function attachToggleButtonListener() {
    if (toggleButton) {
      toggleButton.removeEventListener("click", toggleSidebar);
    }

    toggleButton = document.getElementById("sidebar-toggle");
    if (toggleButton) {
      toggleButton.addEventListener("click", toggleSidebar);
    }
  }

  function handleAfterSwap() {
    if (window.location.pathname.startsWith(basePath + "/")) {
      attachToggleButtonListener();
      restoreSidebarState();
    }
  }

  attachToggleButtonListener();
  restoreSidebarState();

  document.addEventListener("astro:after-swap", handleAfterSwap);

  document.addEventListener("astro:before-swap", () => {
    if (toggleButton) {
      toggleButton.removeEventListener("click", toggleSidebar);
      toggleButton = null;
    }
    document.removeEventListener("astro:after-swap", handleAfterSwap);
  });

  window.addEventListener("resize", () => {
    const sidebar = document.getElementById("sidebar");
    if (sidebar && window.innerWidth >= 1024) {
      sidebar.classList.remove("sidebar-show");
    }
    restoreSidebarState();
  });
</script>
